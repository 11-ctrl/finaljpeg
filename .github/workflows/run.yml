name: MMSP Mode 0 Test (with diff & cmp)

on:
  push:
  pull_request:

jobs:
  mode0-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential

    - name: Download test image (Kimberly.bmp)
      run: |
        curl -L -o Kimberly.bmp \
        https://raw.githubusercontent.com/cychiang-ntpu/mmsp-2025-final-jpeg/main/Kimberly.bmp

    - name: Build encoder and decoder
      run: |
        make

    - name: Run Mode 0 encoder
      run: |
        ./encoder 0 Kimberly.bmp R.txt G.txt B.txt dim.txt

    - name: Run Mode 0 decoder
      run: |
        ./decoder 0 ResKimberly.bmp R.txt G.txt B.txt dim.txt

    - name: Diff original and reconstructed BMP
      run: |
        echo "Running diff..."
        diff Kimberly.bmp ResKimberly.bmp

    - name: Cmp original and reconstructed BMP
      run: |
        echo "Running cmp..."
        cmp Kimberly.bmp ResKimberly.bmp

    - name: Success message
      run: |
        echo "Mode 0 passed: encoder + decoder are bit-exact."
        - name: Upload artifacts (outputs)
      uses: actions/upload-artifact@v4
      with:
        name: mode0-results
        path: |
          ResKimberly.bmp
          R.txt
          G.txt
          B.txt
          dim.txt
